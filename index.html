<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Melodies of ImƒÅn</title>
  <link rel="icon" type="image/png" href="/images/logo.ico" sizes="32x32">
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      min-height: 100vh;
      padding: 10px;
      overflow-y: auto;
      margin: 0;
      background-color: #f5f5f5;
      font-family: Arial, sans-serif;
      transition: background-color 0.3s, color 0.3s;
      color: #000;
      display: block;
    }
    
    @media (min-width: 768px) {
      body {
        padding-top: 20px;
      }
    }

    .header-container, .main-container {
      margin: 0 auto;
    }

    .left-column, .right-column {
      background-color: #fff;
      color: #000000;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    
    @media (min-width: 768px) {
      .left-column, .right-column {
        padding: 20px 30px;
      }
    }

    .left-column {
      flex: 2;
    }

    .right-column {
      flex: 1;
    }
    .right-column .button {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 14px 24px;
      border-radius: 8px;
      background-color: #256328;
      color: white;
      text-decoration: none;
      font-size: 1.1rem;
      transition: background 0.2s, color 0.3s;
      height: 36px;
      box-sizing: border-box;
      font-family: "Al Bayan", "Al Tarikh", sans-serif;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .right-column .button:hover {
      background-color: #254563;
    }
    .header-container {
      width: 100%;
      max-width: 1200px;
      margin: 0 auto 15px auto;
      text-align: center;
      padding: 0 10px;
    }
    .header-container img {
      max-height: 80px;
      object-fit: contain;
      margin-bottom: 8px;
    }
    .header-container h1 {
      font-family: "A Thuluth", serif;
      color: #C99F35;
      font-size: 1.5rem;
      margin: 10px 0;
    }
    
    @media (min-width: 768px) {
      .header-container {
        margin: 0 auto 20px auto;
      }
      .header-container img {
        max-height: 120px;
        margin-bottom: 10px;
      }
      .header-container h1 {
        font-size: 2rem;
      }
    }

    .button-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 8px;
      grid-auto-rows: 1fr;
    }
    
    @media (min-width: 480px) {
      .button-container {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 10px;
      }
    }
    .button {
      display: inline-block;
      padding: 8px 12px;
      background-color: #256328;
      color: white;
      text-decoration: none;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
      user-select: none;
      outline: none;
      transition: background 0.2s, color 0.3s;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Al Bayan", "Al Tarikh", sans-serif;
      white-space: nowrap;
    }
    
    @media (min-width: 768px) {
      .button {
        padding: 8px 14px;
        font-size: 1rem;
      }
    }

    #darkModeToggle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      font-size: 1.3rem;
    }

    #openAuthModalBtn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      font-size: 1.3rem;
    }
    
    #userDropdownBtn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      font-size: 1.3rem;
    }
    .button:hover,
    .poem-button:hover {
      background-color: #254563;
    }

    .poem-button {
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 10px 8px;
      border-radius: 8px;
      background-color: #256328;
      color: white;
      text-decoration: none;
      font-size: 0.9rem;
      transition: background 0.2s, color 0.3s;
      height: 100%;
      min-height: 60px;
      box-sizing: border-box;
      font-family: "Al Bayan", "Al Tarikh", sans-serif;
      position: relative;
      word-wrap: break-word;
      overflow-wrap: break-word;
      hyphens: auto;
    }
    
    @media (min-width: 480px) {
      .poem-button {
        padding: 12px 16px;
        font-size: 1rem;
      }
    }
    
    @media (min-width: 768px) {
      .poem-button {
        padding: 14px 24px;
        font-size: 1.1rem;
      }
    }

    .poem-button .favorite-star {
      position: absolute;
      top: 4px;
      right: 4px;
      font-size: 0.9rem;
      cursor: pointer;
      user-select: none;
      z-index: 10;
      transition: transform 0.2s;
    }

    .poem-button .favorite-star:hover {
      transform: scale(1.3);
    }

    .poem-button .favorite-star.active {
      color: #FFD700;
    }

    .filter-button {
      display: inline-block;
      padding: 8px 10px;
      background-color: #254563;
      color: white;
      text-decoration: none;
      font-size: 0.85rem;
      border: none;
      cursor: pointer;
      user-select: none;
      outline: none;
      transition: background 0.2s, color 0.3s;
      border-radius: 12px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: "Al Bayan", "Al Tarikh", sans-serif;
      white-space: nowrap;
    }
    
    @media (min-width: 768px) {
      .filter-button {
        padding: 8px 14px;
        font-size: 1rem;
      }
    }
    .filter-button:hover {
      background-color: #254563de;
    }

    .dark-mode .button,
    .dark-mode .poem-button {
      background-color: #53A2A9;
    }
    .dark-mode .button:hover,
    .dark-mode .poem-button:hover {
      background-color: #3d8e99;
    }
    .dark-mode .filter-button {
      background-color: #407253;
    }
    .dark-mode .filter-button:hover {
      background-color: #355f47;
    }

    .dark-mode body {
      background-color: #121212;
      color: #e0e0e0;
    }
    .dark-mode .left-column, .dark-mode .right-column {
      background: #1e1e1e;
      box-shadow: 0 4px 10px rgba(255,255,255,0.1);
    }
    .dark-mode h1 {
      color: #53A2A9;
    }
    .dark-mode p {
      color: #b0b0b0;
    }
        @font-face {
      font-family: "Diwan Thuluth";
      src: url("fonts/DiwanThuluth.ttf") format("truetype");
    }
    h1 {
      font-family: "Diwan Thuluth", serif;
      color: #C99F35;
    }
        #searchInput {
      width: 100%;
      max-width: 100%;
      height: 30px;
      padding: 10px 14px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      text-align: left;
      font-size: 0.85rem;
      background: #fff;
      color: #000;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
      box-sizing: border-box;
    }
    
    @media (min-width: 768px) {
      #searchInput {
        max-width: 600px;
        margin-bottom: 20px;
        font-size: 0.9rem;
      }
    }

    html.dark-mode #searchInput {
      background: #333;
      color: #e0e0e0;
      border: 1px solid #555;
    }
    #filter-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    @media (min-width: 768px) {
      #filter-controls {
        margin-bottom: 18px;
      }
    }

    .main-container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
      padding-top: 20px;
      box-sizing: border-box;
    }

    @media (max-width: 768px) {
      .main-container {
        grid-template-columns: 1fr;
      }
      .left-column,
      .right-column {
        width: 100%;
      }
    }

    @media (min-width: 769px) and (max-width: 1200px) {
      .main-container {
        grid-template-columns: 1.5fr 1fr;
      }
    }

    @media (min-width: 1201px) {
      .main-container {
        grid-template-columns: 2fr 1fr;
      }
    }
    .dark-mode .right-column h2 {
      color: #ffffff;
    }
    #roomCodeInput {
      width: 100%;
      max-width: 100%;
      height: 30px;
      padding: 8px 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      box-sizing: border-box;
      background: #fff;
      color: #000;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
    }
    
    @media (min-width: 768px) {
      #roomCodeInput {
        max-width: 250px;
      }
    }

    .dark-mode #roomCodeInput {
      background: #333;
      color: #e0e0e0;
      border: 1px solid #555;
    }
    #createRoomOptions input {
      width: 100%;
      max-width: 100%;
      height: 30px;
      padding: 8px 12px;
      margin-bottom: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      box-sizing: border-box;
      background: #fff;
      color: #000;
      transition: background 0.3s, color 0.3s, border-color 0.3s;
    }
    
    @media (min-width: 768px) {
      #createRoomOptions input {
        max-width: 250px;
      }
    }
    
    .right-column h2 {
      font-size: 1.2rem;
      margin-top: 0;
    }
    
    @media (min-width: 768px) {
      .right-column h2 {
        font-size: 1.5rem;
      }
    }

    .dark-mode #createRoomOptions input {
      background: #333;
      color: #e0e0e0;
      border: 1px solid #555;
    }
    
    /* User dropdown styles */
    .user-dropdown {
      position: relative;
      display: inline-block;
    }
    
    .user-dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      top: 45px;
      background-color: #fff;
      min-width: 180px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      border-radius: 8px;
      z-index: 1000;
      overflow: hidden;
    }
    
    .dark-mode .user-dropdown-content {
      background-color: #2a2a2a;
      box-shadow: 0 8px 16px rgba(255,255,255,0.1);
    }
    
    .user-dropdown-content.show {
      display: block;
    }
    
    .user-dropdown-header {
      padding: 12px 16px;
      border-bottom: 1px solid #e0e0e0;
      font-size: 0.85rem;
      color: #666;
      font-weight: 500;
    }
    
    .dark-mode .user-dropdown-header {
      border-bottom: 1px solid #444;
      color: #aaa;
    }
    
    .user-dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #000;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-family: "Al Bayan", "Al Tarikh", sans-serif;
    }
    
    .dark-mode .user-dropdown-item {
      color: #e0e0e0;
    }
    
    .user-dropdown-item:hover {
      background-color: #f5f5f5;
    }
    
    .dark-mode .user-dropdown-item:hover {
      background-color: #333;
    }
    
    .user-dropdown-divider {
      height: 1px;
      background-color: #e0e0e0;
      margin: 4px 0;
    }
    
    .dark-mode .user-dropdown-divider {
      background-color: #444;
    }
  </style>
</head>
<body>
  <div class="header-container">
    <img src="images/logo.png" alt="Logo">
    <h1>ŸÉŸÄŸÄŸÄÿ™ÿßÿ®   ÿ£ÿµŸàÿßÿ™   ÿßŸÑÿ•ŸäŸÖÿßŸÜ</h1>
  </div>
  <div class="main-container">
    <div class="left-column">
      <input type="text" id="searchInput" placeholder="üîç Search by poem name or tag">
      <div id="filter-controls">
        <div id="tag-filter-container" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-start;"></div>
        <div style="display: flex; align-items: center; gap: 8px;">
          <button id="openAuthModalBtn" class="button" type="button" style="margin-bottom:0;">üë§</button>
          <div class="user-dropdown" id="userDropdown" style="display:none;">
            <button id="userDropdownBtn" class="button" type="button" style="margin-bottom:0;">üë§</button>
            <div class="user-dropdown-content" id="userDropdownContent">
              <div class="user-dropdown-header" id="userDropdownHeader">User</div>
              <div class="user-dropdown-divider"></div>
              <button class="user-dropdown-item" id="viewProfileBtn">
                <span>üë§</span>
                <span>Profile</span>
              </button>
              <button class="user-dropdown-item" id="viewFavoritesBtn">
                <span>‚≠ê</span>
                <span>My Favorites</span>
              </button>
              <div class="user-dropdown-divider"></div>
              <button class="user-dropdown-item" id="dropdownSignOutBtn">
                <span>üö™</span>
                <span>Sign Out</span>
              </button>
            </div>
          </div>
          <button id="darkModeToggle" class="button">üåô</button>
        </div>
      </div>
      <div class="button-container"></div>
    </div>
    <div class="right-column">
      <h2>Join or Create a Room</h2>
      <input type="text" id="roomCodeInput" placeholder="üî† Enter Room Code">
      <button id="joinRoomBtn" class="button">Join Room</button>
      <button id="createRoomBtn" class="button">Create Room </button>
      <div id="createRoomOptions" style="display: none;">
      </div>
      <div id="currentRoomInfo"></div>
      <div id="authSection">
        <div id="authModal" style="display:none; position:fixed; z-index:1000; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.45); align-items:center; justify-content:center;">
          <div style="background:#fff; color:#000; border-radius:16px; max-width:340px; width:90vw; margin:auto; padding:32px 24px 18px 24px; box-shadow:0 10px 32px rgba(0,0,0,0.22); position:relative;">
            <button id="closeAuthModalBtn" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:1.2rem; cursor:pointer;">‚úñ</button>
            <h3 style="text-align:center; margin-top:0; margin-bottom:18px; color:#256328;">Sign In or Register</h3>
            <div style="margin-bottom:14px; display:flex; flex-direction:column; gap:8px;">
              <button id="modalGoogleSignInBtn" class="button" type="button">Sign in with Google</button>
              <button id="modalAppleSignInBtn" class="button" type="button">Sign in with Apple</button>
            </div>
            <div style="margin-bottom:12px;">
              <input id="modalEmailInput" type="email" placeholder="Email" style="margin-bottom:4px;width:95%;max-width:210px;"><br>
              <input id="modalPasswordInput" type="password" placeholder="Password" style="margin-bottom:4px;width:95%;max-width:210px;"><br>
              <button id="modalEmailSignInBtn" class="button" type="button">Sign in with Email</button>
            </div>
            <div style="margin-bottom:8px;">
              <input id="modalPhoneInput" type="tel" placeholder="Phone Number (+1234567890)" style="margin-bottom:4px;width:95%;max-width:210px;"><br>
              <div id="modal-recaptcha-container" style="margin-bottom:4px;"></div>
              <button id="modalPhoneSignInBtn" class="button" type="button">Sign in with Phone</button>
              <div id="modalPhoneVerificationSection" style="margin-top:4px;display:none;">
                <input id="modalPhoneCodeInput" type="text" placeholder="Verification Code" style="width:95%;max-width:210px;margin-bottom:4px;">
                <button id="modalVerifyPhoneCodeBtn" class="button" type="button">Verify Code</button>
              </div>
            </div>
          </div>
        </div>
        <p id="userInfo"></p>
      </div>
    </div>
  </div>
  <script type="module">

    const toggleButton = document.getElementById('darkModeToggle');
    const prefersDarkScheme = window.matchMedia("(prefers-color-scheme: dark)");

    function setDarkMode(enabled) {
      if (enabled) {
        document.documentElement.classList.add('dark-mode');
      } else {
        document.documentElement.classList.remove('dark-mode');
      }
    }

    setDarkMode(prefersDarkScheme.matches);

    prefersDarkScheme.addEventListener('change', e => {
      setDarkMode(e.matches);
    });

    toggleButton.addEventListener('click', () => {
      const isDarkMode = document.documentElement.classList.contains('dark-mode');
      setDarkMode(!isDarkMode);
    });

    // Searchable poems list with filtering
    let poems = [];
    let filteredPoems = [];
    let currentTag = null;
    let userFavorites = new Set();
    let currentUser = null;

    const container = document.querySelector('.button-container');
    const tagFilterContainer = document.getElementById('tag-filter-container');
    const searchInput = document.getElementById('searchInput');

    function displayPoems(poemsArray) {
      container.innerHTML = '';
      let poemsToDisplay = poemsArray;
      const isHomePage = window.location.pathname.endsWith('index.html') || window.location.pathname === '/' || window.location.pathname === '';
      if (isHomePage) {
        poemsToDisplay = poemsArray.filter(poem => poem.id !== 'index');
      }
      poemsToDisplay.forEach(poem => {
        const a = document.createElement('a');
        a.className = 'poem-button';
        a.href = poem.file;
        
        const titleSpan = document.createElement('span');
        titleSpan.textContent = poem.title;
        a.appendChild(titleSpan);

        // Add favorite star if user is logged in
        if (currentUser) {
          const star = document.createElement('span');
          star.className = 'favorite-star';
          star.textContent = userFavorites.has(poem.id) ? '‚òÖ' : '‚òÜ';
          if (userFavorites.has(poem.id)) {
            star.classList.add('active');
          }
          
          star.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            await toggleFavorite(poem.id, star);
          });
          
          a.appendChild(star);
        }
        
        container.appendChild(a);
      });
    }

    async function toggleFavorite(poemId, starElement) {
      if (!currentUser) return;
      
      try {
        if (userFavorites.has(poemId)) {
          userFavorites.delete(poemId);
          starElement.textContent = '‚òÜ';
          starElement.classList.remove('active');
        } else {
          userFavorites.add(poemId);
          starElement.textContent = '‚òÖ';
          starElement.classList.add('active');
        }
        
        // Save to Firestore
        await setDoc(doc(db, "favorites", currentUser.uid), {
          poems: Array.from(userFavorites),
          updatedAt: new Date().toISOString()
        });
      } catch (error) {
        console.error('Error updating favorites:', error);
      }
    }

    async function loadFavorites(userId) {
      if (!userId) {
        userFavorites.clear();
        return;
      }
      
      try {
        const docRef = doc(db, "favorites", userId);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          userFavorites = new Set(data.poems || []);
        } else {
          userFavorites.clear();
        }
      } catch (error) {
        console.error('Error loading favorites:', error);
        userFavorites.clear();
      }
    }

    function getUniqueTags(poems) {
      const tags = new Set();
      poems.forEach(poem => {
        if (Array.isArray(poem.tags)) {
          poem.tags.forEach(tag => tags.add(tag));
        }
      });
      return Array.from(tags).sort((a, b) => a.localeCompare(b));
    }

    function renderTagButtons(poems) {
      tagFilterContainer.innerHTML = '';
      
      // "All" button
      const allBtn = document.createElement('button');
      allBtn.textContent = 'All';
      allBtn.className = 'filter-button';
      if (!currentTag) allBtn.style.backgroundColor = '#C99F35';
      allBtn.addEventListener('click', () => {
        currentTag = null;
        highlightTagButton(null);
        filterAndDisplay();
      });
      tagFilterContainer.appendChild(allBtn);

      // "Favorites" button (only if logged in)
      if (currentUser) {
        const favBtn = document.createElement('button');
        favBtn.textContent = '‚òÖ Favorites';
        favBtn.className = 'filter-button';
        favBtn.setAttribute('data-tag', 'favorites');
        if (currentTag === 'favorites') favBtn.style.backgroundColor = '#C99F35';
        favBtn.addEventListener('click', () => {
          currentTag = 'favorites';
          highlightTagButton('favorites');
          filterAndDisplay();
        });
        tagFilterContainer.appendChild(favBtn);
      }

      // Tag buttons
      getUniqueTags(poems).forEach(tag => {
        const btn = document.createElement('button');
        btn.textContent = tag;
        btn.className = 'filter-button';
        btn.setAttribute('data-tag', tag);
        if (currentTag === tag) btn.style.backgroundColor = '#C99F35';
        btn.addEventListener('click', () => {
          currentTag = tag;
          highlightTagButton(tag);
          filterAndDisplay();
        });
        tagFilterContainer.appendChild(btn);
      });
    }

    function highlightTagButton(selectedTag) {
      tagFilterContainer.querySelectorAll('.filter-button').forEach(btn => {
        btn.style.backgroundColor = '';
      });
      
      if (selectedTag === null) {
        const allBtn = tagFilterContainer.querySelector('.filter-button');
        if (allBtn) allBtn.style.backgroundColor = '#C99F35';
      } else {
        const btn = tagFilterContainer.querySelector(`.filter-button[data-tag="${CSS.escape(selectedTag)}"]`);
        if (btn) btn.style.backgroundColor = '#C99F35';
      }
    }

    function filterAndDisplay() {
      let result = poems;
      const searchTerm = searchInput.value.trim().toLowerCase();
      
      // Filter by favorites
      if (currentTag === 'favorites') {
        result = result.filter(poem => userFavorites.has(poem.id));
      } else if (currentTag) {
        result = result.filter(poem =>
          Array.isArray(poem.tags) && poem.tags.includes(currentTag)
        );
      }
      
      if (searchTerm) {
        result = result.filter(poem => {
          if (poem.title && poem.title.toLowerCase().includes(searchTerm)) return true;
          if (Array.isArray(poem.tags) && poem.tags.some(tag => tag.toLowerCase().includes(searchTerm))) return true;
          return false;
        });
      }
      displayPoems(result);
    }

    // Fetch poems list
    fetch('https://raw.githubusercontent.com/youwi-08/qasidacollectionjson/main/poems-list.json')
      .then(response => response.json())
      .then(data => {
        poems = data;
        renderTagButtons(poems);
        displayPoems(poems);
      })
      .catch(error => {
        console.error('Error fetching poems list:', error);
      });

    searchInput.addEventListener('input', () => {
      filterAndDisplay();
    });


    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";

    const firebaseApp = initializeApp({
      apiKey: "AIzaSyANZ0TUYv-pVhU0ZbD7MTT5Ugm2IjCgeXE",
      authDomain: "qasidacollection2.firebaseapp.com",
      projectId: "qasidacollection2",
      storageBucket: "qasidacollection2.firebasestorage.app",
      messagingSenderId: "238399206269",
      appId: "1:238399206269:web:eb532025660d83f98c5214",
      measurementId: "G-ZWNCJLB60F"
    });

    const db = getFirestore(firebaseApp);
    import {
      getAuth,
      GoogleAuthProvider,
      OAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged,
      signInWithEmailAndPassword,
      createUserWithEmailAndPassword,
      RecaptchaVerifier,
      signInWithPhoneNumber
    } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
    const auth = getAuth(firebaseApp);
    const googleProvider = new GoogleAuthProvider();

    const createRoomBtn = document.getElementById('createRoomBtn');
    const createRoomOptions = document.getElementById('createRoomOptions');
    const currentRoomInfo = document.getElementById('currentRoomInfo');
    let createRoomVisible = false;

    function generateRoomCode(length = 6) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      return Array.from({ length }, () => chars.charAt(Math.floor(Math.random() * chars.length))).join('');
    }

createRoomBtn.addEventListener('click', async () => {
  if (!currentUser) {
    currentRoomInfo.textContent = '‚ö† You must be signed in to create a room.';
    currentRoomInfo.style.color = '#d9534f';
    return;
  }

  const roomCode = generateRoomCode();

  try {
    await setDoc(doc(db, "rooms", roomCode), {
      createdAt: new Date().toISOString()
    });
    window.location.href = '/room-admin?room=' + encodeURIComponent(roomCode);
  } catch (error) {
    console.error('Error creating room:', error);
    currentRoomInfo.textContent = 'Failed to create room. Check console for details.';
    currentRoomInfo.style.color = '#d9534f';
  }

  createRoomOptions.style.display = createRoomVisible ? 'none' : 'block';
  createRoomVisible = !createRoomVisible;
});

    async function verifyRoom(roomCode) {
      if (!roomCode) return;
      try {
        const docRef = doc(db, "rooms", roomCode);
        const docSnap = await getDoc(docRef);
        if (docSnap.exists()) {
          currentRoomInfo.textContent = `Joined Room: ${roomCode}`;
        } else {
          currentRoomInfo.textContent = 'Room does not exist.';
        }
      } catch (error) {
        console.error('Error verifying room:', error);
        currentRoomInfo.textContent = 'Error verifying room. Check console for details.';
      }
    }

    function getRoomParam() {
      const params = new URLSearchParams(window.location.search);
      return params.get('room');
    }
    const initialRoom = getRoomParam();
    if (initialRoom) {
      verifyRoom(initialRoom);
    }

    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const roomCodeInput = document.getElementById('roomCodeInput');
    joinRoomBtn.addEventListener('click', () => {
      const code = roomCodeInput.value.trim().toUpperCase();
      if (code) {
        window.location.href = 'room.html?room=' + encodeURIComponent(code);
      }
    });

    const signOutBtn = document.getElementById('signOutBtn');
    const userInfo = document.getElementById('userInfo');
    const openAuthModalBtn = document.getElementById('openAuthModalBtn');
    const authModal = document.getElementById('authModal');
    const closeAuthModalBtn = document.getElementById('closeAuthModalBtn');
    
    // User dropdown elements
    const userDropdown = document.getElementById('userDropdown');
    const userDropdownBtn = document.getElementById('userDropdownBtn');
    const userDropdownContent = document.getElementById('userDropdownContent');
    const userDropdownHeader = document.getElementById('userDropdownHeader');
    const dropdownSignOutBtn = document.getElementById('dropdownSignOutBtn');
    const viewProfileBtn = document.getElementById('viewProfileBtn');
    const viewFavoritesBtn = document.getElementById('viewFavoritesBtn');

    const modalGoogleSignInBtn = document.getElementById('modalGoogleSignInBtn');
    const modalAppleSignInBtn = document.getElementById('modalAppleSignInBtn');
    const modalEmailSignInBtn = document.getElementById('modalEmailSignInBtn');
    const modalPhoneSignInBtn = document.getElementById('modalPhoneSignInBtn');
    const modalEmailInput = document.getElementById('modalEmailInput');
    const modalPasswordInput = document.getElementById('modalPasswordInput');
    const modalPhoneInput = document.getElementById('modalPhoneInput');
    const modalRecaptchaContainer = document.getElementById('modal-recaptcha-container');
    const modalPhoneVerificationSection = document.getElementById('modalPhoneVerificationSection');
    const modalPhoneCodeInput = document.getElementById('modalPhoneCodeInput');
    const modalVerifyPhoneCodeBtn = document.getElementById('modalVerifyPhoneCodeBtn');

    let modalConfirmationResult = null;
    let modalRecaptchaVerifier = null;

    function showUser(user) {
      let display = user.displayName || user.email || user.phoneNumber || "User";
      userInfo.textContent = `Signed in as ${display}`;
    }

    async function updateAuthUI(user) {
      currentUser = user;
      if (user) {
        showUser(user);
        openAuthModalBtn.style.display = 'none';
        userDropdown.style.display = 'inline-block';
        
        // Update dropdown header with user info
        let display = user.displayName || user.email || user.phoneNumber || "User";
        userDropdownHeader.textContent = display;
        
        await loadFavorites(user.uid);
        renderTagButtons(poems);
        filterAndDisplay();
      } else {
        userInfo.textContent = '';
        openAuthModalBtn.style.display = 'inline-block';
        userDropdown.style.display = 'none';
        userFavorites.clear();
        currentTag = currentTag === 'favorites' ? null : currentTag;
        renderTagButtons(poems);
        filterAndDisplay();
        if (authModal) {
          modalPasswordInput.value = '';
          modalPhoneInput.value = '';
          modalPhoneCodeInput.value = '';
          modalPhoneVerificationSection.style.display = 'none';
        }
      }
    }
    
    // Toggle dropdown
    userDropdownBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      userDropdownContent.classList.toggle('show');
    });
    
    // Close dropdown when clicking outside
    window.addEventListener('click', (e) => {
      if (!userDropdown.contains(e.target)) {
        userDropdownContent.classList.remove('show');
      }
    });
    
    // Dropdown actions
    dropdownSignOutBtn.addEventListener('click', async () => {
      userDropdownContent.classList.remove('show');
      await signOut(auth);
    });
    
    viewProfileBtn.addEventListener('click', () => {
      userDropdownContent.classList.remove('show');
      alert('Profile feature coming soon!');
    });
    
    viewFavoritesBtn.addEventListener('click', () => {
      userDropdownContent.classList.remove('show');
      currentTag = 'favorites';
      highlightTagButton('favorites');
      filterAndDisplay();
    });

    openAuthModalBtn.addEventListener('click', () => {
      authModal.style.display = 'flex';
      modalEmailInput.value = '';
      modalPasswordInput.value = '';
      modalPhoneInput.value = '';
      modalPhoneCodeInput.value = '';
      modalPhoneVerificationSection.style.display = 'none';
    });
    closeAuthModalBtn.addEventListener('click', () => {
      authModal.style.display = 'none';
    });
    authModal.addEventListener('click', (e) => {
      if (e.target === authModal) {
        authModal.style.display = 'none';
      }
    });

    modalGoogleSignInBtn.addEventListener('click', async () => {
      try {
        const result = await signInWithPopup(auth, googleProvider);
        console.log('Sign in successful:', result.user);
        authModal.style.display = 'none';
      } catch (error) {
        console.error('Google Sign-in error:', error);
        alert('Google sign-in error: ' + error.message);
      }
    });

    modalAppleSignInBtn.addEventListener('click', async () => {
      try {
        const appleProvider = new OAuthProvider('apple.com');
        const result = await signInWithPopup(auth, appleProvider);
        console.log('Apple sign in successful:', result.user);
        authModal.style.display = 'none';
      } catch (error) {
        console.error('Apple Sign-in error:', error);
        alert('Apple sign-in error: ' + error.message);
      }
    });

    modalEmailSignInBtn.addEventListener('click', async () => {
      const email = modalEmailInput.value.trim();
      const password = modalPasswordInput.value;
      if (!email || !password) {
        alert('Please enter both email and password.');
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, password);
        authModal.style.display = 'none';
      } catch (error) {
        if (error.code === "auth/user-not-found") {
          try {
            await createUserWithEmailAndPassword(auth, email, password);
            authModal.style.display = 'none';
          } catch (err) {
            console.error('Registration error:', err);
            alert('Could not register with email. See console.');
          }
        } else if (error.code === "auth/wrong-password") {
          alert('Wrong password.');
        } else {
          console.error('Email sign-in error:', error);
          alert('Email sign-in error. See console.');
        }
      }
    });

    function setupModalRecaptcha() {
      if (!modalRecaptchaVerifier) {
        modalRecaptchaVerifier = new RecaptchaVerifier(
          modalRecaptchaContainer,
          {
            size: "normal",
            callback: (response) => {
            }
          },
          auth
        );
        modalRecaptchaVerifier.render();
      }
    }

    modalPhoneSignInBtn.addEventListener('click', async () => {
      const phone = modalPhoneInput.value.trim();
      if (!phone) {
        alert('Please enter your phone number.');
        return;
      }
      setupModalRecaptcha();
      try {
        modalConfirmationResult = await signInWithPhoneNumber(auth, phone, modalRecaptchaVerifier);
        modalPhoneVerificationSection.style.display = 'block';
        alert('SMS sent. Please enter the verification code.');
      } catch (error) {
        console.error('Phone sign-in error:', error);
        alert('Phone sign-in error. See console.');
      }
    });

    modalVerifyPhoneCodeBtn.addEventListener('click', async () => {
      const code = modalPhoneCodeInput.value.trim();
      if (!modalConfirmationResult || !code) {
        alert('Please request code and enter it.');
        return;
      }
      try {
        await modalConfirmationResult.confirm(code);
        modalPhoneVerificationSection.style.display = 'none';
        authModal.style.display = 'none';
      } catch (error) {
        console.error('Phone code verification error:', error);
        alert('Invalid code.');
      }
    });

    onAuthStateChanged(auth, async (user) => {
      console.log('Auth state changed:', user ? 'User signed in' : 'User signed out');
      await updateAuthUI(user);
      if (user && authModal.style.display !== 'none') {
        authModal.style.display = 'none';
      }
    });

  </script>
</body></html>